{% extends "base.html" %}
{% block title %}Suralar — TASNIM{% endblock %}
{% block content %}

<style>
  .tn-page{background:linear-gradient(135deg,#0f4c3a 0%,#1e6b5a 50%,#2d8f7a 100%);
           min-height:calc(100vh - 220px); 
  .tn-container{max-width:1200px;margin:0 auto;padding:20px}
  /* Header */
  .tn-header{background:rgba(255,255,255,.95);backdrop-filter:blur(10px);padding:20px 0;text-align:center;border-radius:15px;margin-bottom:30px;box-shadow:0 8px 32px rgba(0,0,0,.1)}
  .tn-header h1{color:#0f4c3a;font-size:2.5em;margin-bottom:10px;font-weight:700}
  .tn-header .tn-subtitle{color:#1e6b5a;font-size:1.3em;margin-bottom:10px;font-weight:600}
  .tn-header .tn-arabic{font-size:1.8em;color:#1e6b5a;margin-bottom:10px;font-weight:700}
  .tn-header p{color:#666;font-size:1.1em}
  /* Nav */
  .tn-nav{background:rgba(255,255,255,.9);backdrop-filter:blur(10px);padding:15px;border-radius:10px;margin-bottom:20px;display:none}
  .tn-nav button{background:#0f4c3a;color:#fff;border:none;padding:10px 20px;border-radius:5px;cursor:pointer;font-size:1em;transition:.3s}
  .tn-nav button:hover{background:#1e6b5a;transform:translateY(-2px)}
  /* Surah list */
  #surah-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:20px}
  .tn-item{background:rgba(255,255,255,.95);backdrop-filter:blur(10px);border-radius:15px;padding:20px;cursor:pointer;transition:.3s;box-shadow:0 4px 20px rgba(0,0,0,.1)}
  .tn-item:hover{transform:translateY(-5px);box-shadow:0 8px 30px rgba(0,0,0,.2);background:#fff}
  .tn-num{background:#0f4c3a;color:#fff;width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;margin-bottom:15px}
  .tn-name{font-size:1.3em;font-weight:700;color:#0f4c3a;margin-bottom:8px}
  .tn-name-ar{font-size:1.5em;color:#1e6b5a;margin-bottom:8px;text-align:right;font-weight:700}
  .tn-info{color:#666;font-size:.9em;display:flex;justify-content:space-between}
  /* Surah view */
  #surah-view{display:none}
  .tn-s-header{background:rgba(255,255,255,.95);backdrop-filter:blur(10px);padding:30px;border-radius:15px;margin-bottom:30px;text-align:center;box-shadow:0 8px 32px rgba(0,0,0,.1)}
  .tn-title{font-size:2.2em;color:#0f4c3a;margin-bottom:10px}
  .tn-title-ar{font-size:2.5em;color:#1e6b5a;margin-bottom:15px;font-weight:700}
  .tn-bism{font-size:1.8em;color:#0f4c3a;margin:20px 0;text-align:center;font-weight:700}
  /* Ayah */
  .tn-ayah{background:rgba(255,255,255,.95);backdrop-filter:blur(10px);border-radius:15px;padding:25px;margin-bottom:20px;box-shadow:0 4px 20px rgba(0,0,0,.1)}
  .tn-ayah-num{background:#0f4c3a;color:#fff;width:35px;height:35px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;font-weight:700;margin-bottom:15px;font-size:.9em}
  .tn-ayah-ar{font-size:1.8em;line-height:1.8;color:#1e6b5a;text-align:right;margin-bottom:20px;font-weight:700;padding:15px;background:rgba(240,248,255,.5);border-radius:10px}
  /* Word-by-word */
  .tn-wbw{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:15px;margin-bottom:20px;padding:15px;background:rgba(248,250,252,.8);border-radius:10px;direction:rtl}
  .tn-pair{text-align:center;padding:10px;background:#fff;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,.1);transition:.3s;direction:ltr}
  .tn-pair:hover{transform:translateY(-2px);box-shadow:0 4px 15px rgba(0,0,0,.2)}
  .tn-pair .tn-ar{font-size:1.5em;color:#1e6b5a;font-weight:700;margin-bottom:8px;min-height:50px;display:flex;align-items:center;justify-content:center}
  .tn-pair .tn-tr{font-size:.9em;color:#0f4c3a;font-weight:500}
  .tn-ayah-tr{font-size:1.1em;line-height:1.6;color:#444;padding:15px;background:rgba(245,255,250,.8);border-radius:10px;border-left:4px solid #0f4c3a}
  .tn-ayah-tr .tn-t{margin:0}
  .tn-ayah-tr .tn-t b{color:#0f4c3a;font-weight:700}
  /* Loading */
  .tn-loading{text-align:center;padding:50px;color:#fff;font-size:1.2em}
  .tn-spin{border:4px solid rgba(255,255,255,.3);border-radius:50%;border-top:4px solid #fff;width:40px;height:40px;animation:tn-spin 1s linear infinite;margin:20px auto}
  @keyframes tn-spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
  /* Messages */
  .tn-err{background:rgba(255,255,255,.95);border-radius:10px;padding:20px;text-align:center;color:#d32f2f;margin:20px 0}
  .tn-off{background:rgba(255,255,255,.95);border-radius:10px;padding:15px;text-align:center;color:#1e6b5a;margin:10px 0;border-left:4px solid #1e6b5a}
  /* Responsive */
  @media (max-width:768px){
    .tn-container{padding:10px}
    .tn-header h1{font-size:2em}
    .tn-header .tn-subtitle{font-size:1.1em}
    #surah-list{grid-template-columns:1fr;gap:15px}
    .tn-wbw{grid-template-columns:repeat(auto-fit,minmax(90px,1fr));gap:10px}
    .tn-ayah-ar{font-size:1.5em}
    .tn-pair .tn-ar{font-size:1.2em;min-height:40px}
  }
</style>

<div class="tn-page">
  <div class="tn-container">
    <!-- Header -->
    <div class="tn-header">
      <h1>TASNIM</h1>
      <div class="tn-subtitle">Qurʼoni Karim maʼnolarining soʻzma-soʻz tarjimasi</div>
      <div class="tn-arabic">القرآن الكريم</div>
    </div>

    <!-- Navigation -->
    <div class="tn-nav" id="navigation">
      <button onclick="showSurahList()">← Suralar ro'yxatiga qaytish</button>
    </div>

    <!-- Surah List -->
    <div id="surah-list"></div>

    <!-- Surah View -->
    <div id="surah-view">
      <div class="tn-s-header" id="surah-header"></div>
      <div id="ayah-container"></div>
    </div>
  </div>
</div>

<!-- Tasnim scripts (scoped) -->
<script>
  // API config (CORS proxy bilan)
  const BASE_URL = 'https://api.tasnim.app';
  const CORS_PROXY = 'https://corsproxy.io/?';
  const SURAH_NAMES_API = `${CORS_PROXY}${encodeURIComponent(BASE_URL + '/api/surahnames')}`;
  const SURAH_AYAHS_API = (surahId) => `${CORS_PROXY}${encodeURIComponent(BASE_URL + '/api/quran/surah/' + surahId)}`;
  const BY_WORDS_API = (surahId) => `${CORS_PROXY}${encodeURIComponent(BASE_URL + '/api/bywords/' + surahId)}`;

  const USERNAME = 'usertsnm';
  const PASSWORD = 'user123Mzn2hZ0qa0a0XL7';
  const AUTH_HEADER = 'Basic ' + btoa(USERNAME + ':' + PASSWORD);

  const localSurahs = [
    {surahNo:1,nameUzlat:"Fotiha",nameArabic:"الفاتحة",suraMeanUzlat:"Ochuvchi",ayahNumber:7},
    {surahNo:2,nameUzlat:"Baqara",nameArabic:"البقرة",suraMeanUzlat:"Sigir",ayahNumber:286},
    {surahNo:3,nameUzlat:"Oli Imron",nameArabic:"آل عمران",suraMeanUzlat:"Imron oilasi",ayahNumber:200},
    {surahNo:4,nameUzlat:"Niso",nameArabic:"النساء",suraMeanUzlat:"Ayollar",ayahNumber:176},
    {surahNo:5,nameUzlat:"Mo'ida",nameArabic:"المائدة",suraMeanUzlat:"Dasturxon",ayahNumber:120},
    {surahNo:114,nameUzlat:"Nos",nameArabic:"الناس",suraMeanUzlat:"Odamlar",ayahNumber:6},
  ];

  const ayahsCache = {};
  const byWordsCache = {};

  async function initApp(){ await renderSurahList(); }

  async function fetchWithAuth(url, options={}){
    const merged = {
      headers: {'Authorization': AUTH_HEADER,'Content-Type':'application/json'},
      mode:'cors',
      ...options
    };
    const res = await fetch(url, merged);
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    return await res.json();
  }

  async function renderSurahList(){
    const box = document.getElementById('surah-list');
    box.innerHTML = '<div class="tn-loading"><div class="tn-spin"></div><p>Suralar ro\'yxati yuklanmoqda...</p></div>';
    try{
      const data = await fetchWithAuth(SURAH_NAMES_API);
      if(Array.isArray(data)) renderSurahItems(data, box);
      else throw new Error('API noto‘g‘ri format qaytardi');
    }catch(err){
      console.warn('API ishlamadi, lokal ma’lumot ishlatiladi:', err);
      box.innerHTML = `<div class="tn-off">⚠️ Internet muammosi. Lokal ma'lumotlar ko'rsatilmoqda.</div>`;
      renderSurahItems(localSurahs, box);
    }
  }

  function renderSurahItems(surahs, container){
    container.innerHTML = '';
    surahs.sort((a,b)=>a.surahNo-b.surahNo);
    surahs.forEach(s=>{
      const el = document.createElement('div');
      el.className = 'tn-item';
      el.onclick = ()=>showSurah(s.surahNo, s);
      el.innerHTML = `
        <div class="tn-num">${s.surahNo}</div>
        <div class="tn-name">${s.nameUzlat}</div>
        <div class="tn-name-ar">${s.nameArabic}</div>
        <div class="tn-info"><span>${s.suraMeanUzlat||''}</span><span>${s.ayahNumber||''} oyat</span></div>
      `;
      container.appendChild(el);
    });
  }

  async function showSurah(num, data=null){
    document.getElementById('surah-list').style.display='none';
    document.getElementById('navigation').style.display='block';
    document.getElementById('surah-view').style.display='block';

    const ayahBox = document.getElementById('ayah-container');
    ayahBox.innerHTML = '<div class="tn-loading"><div class="tn-spin"></div><p>Oyatlar yuklanmoqda...</p></div>';

    try{
      if(!data){
        data = localSurahs.find(s=>s.surahNo===num) || {surahNo:num,nameUzlat:`Sura ${num}`,nameArabic:`سورة ${num}`};
      }
      const [ayahs, wbw] = await Promise.all([ fetchAyahs(num), fetchByWords(num) ]);

      const head = document.getElementById('surah-header');
      head.innerHTML = `
        <div class="tn-title">${data.nameUzlat||''}</div>
        <div class="tn-title-ar">${data.nameArabic||''}</div>
        <p>${data.suraMeanUzlat||''} • ${data.ayahNumber||''} oyat</p>
        ${num!==1 && num!==9 ? '<div class="tn-bism">بِسْمِ اللَّهِ الرَّحْمَٰنِ الرَّحِيمِ</div>' : ''}
      `;

      renderAyahsWithWords(ayahs, wbw, ayahBox);
    }catch(e){
      console.error(e);
      ayahBox.innerHTML = `
        <div class="tn-err">
          <p>${num}-sura oyatlarini yuklashda xatolik yuz berdi.</p>
          <p>${e.message}</p>
          <button onclick="showSurah(${num})" style="background:#0f4c3a;color:#fff;border:none;padding:10px 20px;border-radius:5px;cursor:pointer;margin-top:15px">Qayta urinish</button>
        </div>`;
    }
    window.scrollTo(0,0);
  }

  async function fetchAyahs(num){
    if(!ayahsCache[num]){
      try{ ayahsCache[num] = await fetchWithAuth(SURAH_AYAHS_API(num)); }
      catch(_){
        ayahsCache[num] = [
          {verseId:1,arabic:"بِسْمِ اللَّهِ الرَّحْمَٰنِ الرَّحِيمِ",uzlat:"<b>Rahmon</b> va <b>Rahim</b> boʻlgan <b>Alloh</b> <b>nomi</b> <b>bilan</b> boshlayman."},
          {verseId:2,arabic:"الْحَمْدُ لِلَّهِ رَبِّ الْعَالَمِينَ",uzlat:"Barcha <b>hamd</b> va sano <b>olamlarning</b> <b>Robbisi</b> boʻlgan <b>Alloh</b> taolo<b>ga</b> xos<b>dir</b>."}
        ];
      }
    }
    return ayahsCache[num];
  }

  async function fetchByWords(num){
    if(!byWordsCache[num]){
      try{ byWordsCache[num] = await fetchWithAuth(BY_WORDS_API(num)); }
      catch(_){ byWordsCache[num] = []; }
    }
    return byWordsCache[num];
  }

  function renderAyahsWithWords(ayahs, wbw, container){
    container.innerHTML = '';
    if(!Array.isArray(ayahs) || !ayahs.length) throw new Error('Sura oyatlari topilmadi');

    ayahs.forEach(a=>{
      const el = document.createElement('div');
      el.className = 'tn-ayah';

      const pairs = Array.isArray(wbw) ? wbw.filter(w=>w.verseId===a.verseId) : [];
      const wbwHtml = pairs.length ? `
        <div class="tn-wbw">
          ${pairs.map(w=>`
            <div class="tn-pair">
              <div class="tn-ar">${w.wordsAr}</div>
              <div class="tn-tr">${w.translateUzlat||''}</div>
            </div>`).join('')}
        </div>` : '';

      el.innerHTML = `
        <div class="tn-ayah-num">${a.verseId}</div>
        <div class="tn-ayah-ar">${a.arabic}</div>
        ${wbwHtml}
        <div class="tn-ayah-tr"><p class="tn-t">${a.uzlat || 'Tarjima mavjud emas'}</p></div>
      `;
      container.appendChild(el);
    });
  }

  function showSurahList(){
    document.getElementById('surah-list').style.display='grid';
    document.getElementById('navigation').style.display='none';
    document.getElementById('surah-view').style.display='none';
  }

  window.addEventListener('DOMContentLoaded', initApp);
</script>

{% endblock %}
